<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PublicChat</title>
<link rel="icon" type="image/png" href="https://i.imgur.com/PqXLWpn.png">
<style>
:root{
  --bg:#000a00;
  --text:#7CFF7C;
  --muted:#4a8b4a;
  --glow:rgba(124,255,124,0.1);
}
html,body{
  height:100%;margin:0;
  background:linear-gradient(#001200,#000800);
  color:var(--text);
  font-family:"VT323","Courier New",monospace;
  display:flex;align-items:center;justify-content:center;
}
.screen{
  width:90%;max-width:800px;padding:2rem;
  border:4px solid rgba(10,40,10,0.7);
  background:linear-gradient(180deg,rgba(0,20,0,0.9),rgba(0,10,0,0.85));
  border-radius:8px;position:relative;overflow:hidden;
  box-shadow:0 0 40px black,0 0 60px rgba(0,255,0,0.05) inset;
}
.screen::before{
  content:"";position:absolute;inset:0;
  background:linear-gradient(transparent 85%,rgba(0,0,0,0.15) 86%);
  background-size:100% 6px;
  animation:scan 3s linear infinite;
  mix-blend-mode:overlay;
  pointer-events:none;
}
.screen::after{
  content:"";position:absolute;inset:0;
  background:repeating-linear-gradient(90deg,rgba(255,255,255,0.02) 0 1px,transparent 1px 12px);
  animation:stripes 6s linear infinite;
  opacity:0.05;pointer-events:none;
}
@keyframes scan{from{background-position-y:0;}to{background-position-y:6px;}}
@keyframes stripes{from{transform:translateX(0);}to{transform:translateX(-40px);}}

h1{text-align:center;font-size:28px;margin-top:0;text-shadow:0 0 8px var(--glow);}
p.lead{text-align:center;color:var(--muted);font-size:14px;}

form{display:flex;gap:10px;margin-top:20px;justify-content:center;}

textarea{
  flex:1;
  max-width:400px;
  background:transparent;
  border:1px solid rgba(124,255,124,0.1);
  padding:10px;
  border-radius:4px;
  color:var(--text);
  font-size:16px;
  outline:none;
  resize:none;
  font-family:"VT323","Courier New",monospace;
  line-height:18px;
  overflow:hidden;
  min-height:0px;
  max-height:18px;
  white-space:pre-wrap;
}

button{
  background:linear-gradient(#0b3,#074);
  color:#001;border:0;border-radius:4px;
  padding:10px 14px;cursor:pointer;font-weight:bold;
}

.messages{
  margin-top:20px;
  display:flex;
  flex-direction:column;
  gap:10px;
  max-height:300px;
  overflow-y:auto;
  padding-right:5px;
}

.message{
  max-width:70%;
  padding:8px 12px;
  border-radius:6px;
  border:1px solid rgba(124,255,124,0.1);
  background:rgba(0,30,0,0.4);
  word-break:break-word;
  white-space:pre-wrap;
  position:relative;
}

.mine{align-self:flex-end;background:rgba(100,255,100,0.2);border-color:rgba(124,255,124,0.5);color:#B8FFB8;font-weight:bold;}
.other{align-self:flex-start;opacity:0.85;}
.special{align-self:flex-start;border:2px solid #3b043d;box-shadow:0 0 10px rgb(59,4,61);font-weight:bold;background:rgba(50,0,50,0.3);}

.message img{display:block;max-width:50%;border:2px solid rgba(124,255,124,0.5);border-radius:6px;margin-top:4px;}

.timestamp{text-align:center;color:var(--muted);font-size:13px;margin:5px 0;opacity:0.8;}

.ip-bubble{
  width:8px;height:8px;border-radius:50%;
  opacity:0.55;position:absolute;bottom:2px;
  border:1px solid rgba(124,255,124,0.5);
}

.mine .ip-bubble{right:2px;}
.other .ip-bubble,.special .ip-bubble{left:2px;}

.tooltip{
  position:fixed;
  background:rgba(0,20,0,0.95);
  color:var(--text);
  padding:6px 10px;
  border:1px solid rgba(124,255,124,0.3);
  border-radius:4px;
  font-size:14px;
  display:none;
  pointer-events:none;
  z-index:9999;
}

.loading-overlay{
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(#001200,#000800);
  color: var(--muted);
  font-size: 22px;
  z-index: 10000;
}
</style>
</head>
<body>
<div id="loadingOverlay" class="loading-overlay">Loading...</div>

<div class="screen">
  <h1>Public Chat</h1>
  <p class="lead">4 messages per day</p>

  <div class="messages" id="messages"></div>

  <form id="chatForm">
    <textarea id="messageInput" maxlength="500" placeholder="Type your message or image URL..."></textarea>
    <button type="submit">Send</button>
  </form>
</div>

<div class="tooltip" id="globalTooltip"></div>

<script>
const BIN_ID = "68e27f0bd0ea881f40961de3";
const COLORS_BIN_ID = "68e3d2d0d0ea881f40975fc7";
const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}/latest`;
const POST_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
const COLORS_URL = `https://api.jsonbin.io/v3/b/${COLORS_BIN_ID}/latest`;
const COLORS_POST_URL = `https://api.jsonbin.io/v3/b/${COLORS_BIN_ID}`;
const maxMessagesPerDay = 4;
const specialIP = "88.156.230.75";

let myIP = null, ipData = {}, firstLoad = true;
let dailyCount = Number(localStorage.getItem("dailyCount")||0);

const messagesEl = document.getElementById("messages");
const input = document.getElementById("messageInput");
const form = document.getElementById("chatForm");
const tooltip = document.getElementById("globalTooltip");
const loading = document.getElementById("loadingOverlay");

function randomColor(){ return "#"+Math.floor(Math.random()*16777215).toString(16).padStart(6,"0"); }
function randomName(){ return "User-"+Math.floor(Math.random()*100000); }

function formatDate(d){ return `${String(d.getDate()).padStart(2,"0")} ${d.toLocaleString("en-US",{month:"long"})} ${d.getFullYear()}`; }
function formatTime(d){ return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`; }

async function loadIPData(){
  try{ ipData = (await (await fetch(COLORS_URL)).json()).record || {}; } catch{} 
}
async function saveIPData(){
  fetch(COLORS_POST_URL,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(ipData)});
}

function createIPBubble(ip){
  const b = document.createElement("div");
  b.className = "ip-bubble";
  b.style.background = ipData[ip]?.color || "#888";
  b.onmouseenter = ()=>{ tooltip.textContent = ipData[ip]?.name || "Unknown"; tooltip.style.display="block"; }
  b.onmousemove = e => { tooltip.style.left = e.pageX+"px"; tooltip.style.top = e.pageY-30+"px"; }
  b.onmouseleave = ()=> tooltip.style.display="none";
  return b;
}

async function loadMessages(scroll=true){
  try{
    const data = (await (await fetch(API_URL)).json()).record || [];
    messagesEl.innerHTML="";
    let lastDate = null, lastMinute = null;

    if(firstLoad){ loading.style.display="none"; firstLoad=false; }

    for(const m of data){
      if(!ipData[m.ip]){ ipData[m.ip]={color:randomColor(),name:randomName()}; saveIPData(); }

      const t = new Date(m.time||0);
      const d = formatDate(t), min = formatTime(t);

      if(d!==lastDate){
        const e = document.createElement("div"); e.className="timestamp"; e.textContent=d; messagesEl.appendChild(e); lastDate=d; lastMinute=null;
      }
      if(min!==lastMinute){
        const e = document.createElement("div"); e.className="timestamp"; e.textContent=min; messagesEl.appendChild(e); lastMinute=min;
      }

      const msg = document.createElement("div");
      msg.className = "message "+(m.ip===myIP?"mine":m.ip===specialIP?"special":"other");

      if(/\.(png|jpg|jpeg|gif|webp|svg)$/i.test(m.text.trim())){
        const img = document.createElement("img"); img.src = m.text.trim(); msg.appendChild(img);
      } else { msg.textContent = m.text; }

      msg.appendChild(createIPBubble(m.ip));
      messagesEl.appendChild(msg);
    }
    if(scroll) messagesEl.scrollTop = messagesEl.scrollHeight;
  } catch{}
}

async function sendMessage(text){
  let admin = false;
  if(text.startsWith("/m")){ admin=true; text=text.slice(2).trim(); if(!text) return; }
  const data = (await (await fetch(API_URL)).json()).record || [];
  const ip = admin ? specialIP : myIP;

  if(!admin && ip!==specialIP && dailyCount>=maxMessagesPerDay){ alert("Daily limit reached"); return; }

  data.push({ip,text,time:Date.now()});
  await fetch(POST_URL,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});

  if(!admin && ip!==specialIP){ dailyCount++; localStorage.setItem("dailyCount",dailyCount); }
  loadMessages(true);
}

form.onsubmit = e=>{
  e.preventDefault();
  const t = input.value.trim();
  if(t) sendMessage(t);
  input.value=""; adjustTextareaHeight();
};

input.addEventListener("keydown",e=>{
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); form.requestSubmit(); }
});

function adjustTextareaHeight(){
  input.style.height="auto";
  input.style.height = Math.min(input.scrollHeight, 72)+"px";
}

input.addEventListener("input", adjustTextareaHeight);

fetch("https://api.ipify.org?format=json")
  .then(r=>r.json())
  .then(async d=>{
    myIP=d.ip; await loadIPData(); loadMessages(); setInterval(()=>loadMessages(false),3000);
  });
</script>
</body>
</html>
